import { ServerFacade } from "../../../src/net/ServerFacade";
import { RegisterRequest } from "tweeter-shared";
import "isomorphic-fetch";

describe("ServerFacade Register Integration", () => {
  let facade: ServerFacade;

  beforeEach(() => {
    facade = new ServerFacade();
  });

  test("registers a new user and returns a valid user and token", async () => {
    const image = JSON.parse(
      '{\
        "type": "Buffer", \
        "data": [\
          137, 80, 78, 71, 13, 10, 26, 10, 0, 0, 0, 13, 73, 72, 68, 82, 0, 0, 0, 1,\
          0, 0, 0, 1, 8, 2, 0, 0, 0, 144, 119, 83, 222, 0, 0, 1, 132, 105, 67, 67,\
          80, 73, 67, 67, 32, 112, 114, 111, 102, 105, 108, 101, 0, 0, 40, 145, 125,\
          145, 61, 72, 195, 64, 28, 197, 95, 83, 197, 162, 21, 17, 59, 136, 56, 4,\
          105, 157, 44, 136, 138, 56, 106, 21, 138, 80, 161, 212, 10, 173, 58, 152,\
          92, 250, 5, 77, 26, 146, 20, 23, 71, 193, 181, 224, 224, 199, 98, 213,\
          193, 197, 89, 87, 7, 87, 65, 16, 252, 0, 113, 23, 156, 20, 93, 164, 196,\
          255, 37, 133, 22, 49, 30, 28, 247, 227, 221, 189, 199, 221, 59, 64, 168,\
          151, 153, 106, 118, 140, 3, 170, 102, 25, 169, 120, 76, 204, 100, 87, 197,\
          174, 87, 244, 160, 31, 1, 140, 32, 34, 49, 83, 159, 75, 38, 19, 240, 28,\
          95, 247, 240, 241, 245, 46, 202, 179, 188, 207, 253, 57, 122, 149, 156,\
          201, 0, 159, 72, 60, 203, 116, 195, 34, 222, 32, 158, 222, 180, 116, 206,\
          251, 196, 33, 86, 148, 20, 226, 115, 226, 49, 131, 46, 72, 252, 200, 117,\
          217, 229, 55, 206, 5, 135, 5, 158, 25, 50, 210, 169, 121, 226, 16, 177,\
          88, 104, 99, 185, 141, 89, 209, 80, 137, 167, 136, 195, 138, 170, 81, 190,\
          144, 113, 89, 225, 188, 197, 89, 45, 87, 89, 243, 158, 252, 133, 193, 156,\
          182, 178, 204, 117, 154, 195, 136, 99, 17, 75, 72, 66, 132, 140, 42, 74,\
          40, 195, 66, 148, 86, 141, 20, 19, 41, 218, 143, 121, 248, 135, 28, 127,\
          146, 92, 50, 185, 74, 96, 228, 88, 64, 5, 42, 36, 199, 15, 254, 7, 191,\
          187, 53, 243, 147, 19, 110, 82, 48, 6, 116, 190, 216, 246, 71, 4, 232,\
          218, 5, 26, 53, 219, 254, 62, 182, 237, 198, 9, 224, 127, 6, 174, 180,\
          150, 191, 82, 7, 102, 62, 73, 175, 181, 180, 240, 17, 208, 183, 13, 92,\
          92, 183, 52, 121, 15, 184, 220, 1, 6, 159, 116, 201, 144, 28, 201, 79, 83,\
          200, 231, 129, 247, 51, 250, 166, 44, 48, 112, 11, 116, 175, 185, 189, 53,\
          247, 113, 250, 0, 164, 169, 171, 196, 13, 112, 112, 8, 140, 22, 40, 123,\
          221, 227, 221, 129, 246, 222, 254, 61, 211, 236, 239, 7, 130, 35, 114,\
          173, 141, 60, 188, 222, 0, 0, 0, 9, 112, 72, 89, 115, 0, 0, 46, 35, 0, 0,\
          46, 35, 1, 120, 165, 63, 118, 0, 0, 0, 7, 116, 73, 77, 69, 7, 233, 11, 17,\
          8, 34, 56, 227, 73, 78, 7, 0, 0, 0, 25, 116, 69, 88, 116, 67, 111, 109,\
          109, 101, 110, 116, 0, 67, 114, 101, 97, 116, 101, 100, 32, 119, 105, 116,\
          104, 32, 71, 73, 77, 80, 87, 129, 14, 23, 0, 0, 0, 12, 73, 68, 65, 84, 8,\
          215, 99, 248, 255, 255, 63, 0, 5, 254, 2, 254, 220, 204, 89, 231, 0, 0, 0,\
          0, 73, 69, 78, 68, 174, 66, 96, 130\
        ]\
      }'
    ); // fake image data
    const request: RegisterRequest = {
      alias: "@allen",
      password: "password123",
      firstname: "Allen",
      lastname: "Doe",
      userImageBytes: image,
      imageFileExtension: ".png",
    };

    const [user, token] = await facade.register(request);

    expect(user).not.toBeNull();
    expect(user?.alias).toBe(request.alias);
    expect(token).toBeDefined();
  });
});
